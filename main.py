import os
import re
import random
import requests
from fastapi import FastAPI, Request

# ===== ENV =====
BOT_TOKEN = os.getenv("BOT_TOKEN")
WEBHOOK_URL = os.getenv("WEBHOOK_URL")
WEATHER_API_KEY = os.getenv("WEATHER_API_KEY")

# ===== GEMINI =====
GEMINI_API_KEY = os.getenv("GEMINI_API_KEY")
GEMINI_MODEL = os.getenv("GEMINI_MODEL", "gemini-2.5-flash")  # –º–æ–∂–Ω–∞ –º—ñ–Ω—è—Ç–∏ –≤ ENV

TELEGRAM_API = f"https://api.telegram.org/bot{BOT_TOKEN}"

app = FastAPI()

# ===== Telegram helpers =====
def send_message(chat_id: int, text: str):
    url = f"{TELEGRAM_API}/sendMessage"
    payload = {"chat_id": chat_id, "text": text}
    try:
        r = requests.post(url, json=payload, timeout=10)
        print("sendMessage status:", r.status_code)
        print("sendMessage response:", r.text)
    except Exception as e:
        print("sendMessage error:", repr(e))


def set_webhook():
    url = f"{TELEGRAM_API}/setWebhook"
    payload = {"url": WEBHOOK_URL, "drop_pending_updates": True}
    r = requests.post(url, json=payload)
    print("Webhook set:", r.text)


# ===== Startup =====
@app.on_event("startup")
async def startup():
    print("Starting up...")
    print("BOT_TOKEN exists:", bool(BOT_TOKEN))
    print("WEBHOOK_URL:", WEBHOOK_URL)
    print("WEATHER_API_KEY exists:", bool(WEATHER_API_KEY))
    print("GEMINI_API_KEY exists:", bool(GEMINI_API_KEY))
    print("GEMINI_MODEL:", GEMINI_MODEL)
    set_webhook()


# ===== Weather =====
CITY_ALIASES = {
    "–∫–∏—î–≤—ñ": "–∫–∏—ó–≤", "–∫–∏—î–≤–∞": "–∫–∏—ó–≤", "–∫–∏—ó–≤": "–∫–∏—ó–≤",
    "–ª—å–≤–æ–≤—ñ": "–ª—å–≤—ñ–≤", "–ª—å–≤–æ–≤–∞": "–ª—å–≤—ñ–≤", "–ª—å–≤—ñ–≤": "–ª—å–≤—ñ–≤",
    "–æ–¥–µ—Å—ñ": "–æ–¥–µ—Å–∞", "–æ–¥–µ—Å–∏": "–æ–¥–µ—Å–∞", "–æ–¥–µ—Å–∞": "–æ–¥–µ—Å–∞",
    "—Ö–∞—Ä–∫–æ–≤—ñ": "—Ö–∞—Ä–∫—ñ–≤", "—Ö–∞—Ä–∫–æ–≤–∞": "—Ö–∞—Ä–∫—ñ–≤", "—Ö–∞—Ä–∫—ñ–≤": "—Ö–∞—Ä–∫—ñ–≤",
    "–¥–Ω—ñ–ø—Ä—ñ": "–¥–Ω—ñ–ø—Ä–æ", "–¥–Ω—ñ–ø—Ä–∞": "–¥–Ω—ñ–ø—Ä–æ", "–¥–Ω—ñ–ø—Ä–æ": "–¥–Ω—ñ–ø—Ä–æ",
    "–∑–∞–ø–æ—Ä—ñ–∂–∂—ñ": "–∑–∞–ø–æ—Ä—ñ–∂–∂—è", "–∑–∞–ø–æ—Ä—ñ–∂–∂—è": "–∑–∞–ø–æ—Ä—ñ–∂–∂—è",
}

CITY_LATIN = {
    "–∫–∏—ó–≤": "Kyiv",
    "–ª—å–≤—ñ–≤": "Lviv",
    "–æ–¥–µ—Å–∞": "Odesa",
    "—Ö–∞—Ä–∫—ñ–≤": "Kharkiv",
    "–¥–Ω—ñ–ø—Ä–æ": "Dnipro",
    "–∑–∞–ø–æ—Ä—ñ–∂–∂—è": "Zaporizhzhia",
}

WEATHER_STOPWORDS = {
    "–ø–æ–≥–æ–¥–∞", "—è–∫–∞", "—è–∫–µ", "—è–∫–∏–π", "–∑–∞—Ä–∞–∑", "—Å—å–æ–≥–æ–¥–Ω—ñ", "–±—É–¥—å", "–ª–∞—Å–∫–∞",
    "–ø–æ–∫–∞–∂–∏", "—Å–∫–∞–∂–∏", "–Ω–∞–ø–∏—à–∏", "–Ω–µ–≥–∞–π–Ω–æ", "–±—É–¥—å-–ª–∞—Å–∫–∞", "–ø–ª—ñ–∑", "–ø–ª–∏–∑",
    "—É", "–≤", "–Ω–∞", "–ø–æ", "–¥–ª—è", "–º—ñ—Å—Ç—ñ", "–º—ñ—Å—Ç–æ", "–ø—Ä–æ",
    "–Ω–µ—Ä—ñ"
}

def extract_city_from_query(q: str) -> str | None:
    s = re.sub(r"[^\w\s\-‚Äô º—ñ—ó—î“ë–∞-—è–ê-–Ø]", " ", q, flags=re.UNICODE).strip().lower()
    parts = [p for p in s.split() if p and p not in WEATHER_STOPWORDS]
    if not parts:
        return None
    if len(parts) >= 2:
        last2 = " ".join(parts[-2:])
        if len(last2) >= 4:
            return last2
    return parts[-1]

def normalize_city(city: str) -> str:
    c = city.strip().lower()
    if c in CITY_ALIASES:
        return CITY_ALIASES[c]

    for suffix, repl in [("–æ–≤—ñ", ""), ("–µ–≤—ñ", ""), ("—ñ", "–∞"), ("—É", "–∞"), ("—ó", "—è")]:
        if len(c) > 4 and c.endswith(suffix):
            guess = c[:-len(suffix)] + repl
            return CITY_ALIASES.get(guess, guess)

    return c

def weather_emoji(main: str) -> str:
    m = (main or "").lower()
    if "clear" in m:
        return "‚òÄÔ∏è"
    if "cloud" in m:
        return "‚òÅÔ∏è"
    if "rain" in m or "drizzle" in m:
        return "üåßÔ∏è"
    if "thunder" in m:
        return "‚õàÔ∏è"
    if "snow" in m:
        return "‚ùÑÔ∏è"
    if "mist" in m or "fog" in m or "haze" in m:
        return "üå´Ô∏è"
    return "üåø"

def _geocode_candidates(city_norm: str) -> list[str]:
    lat = CITY_LATIN.get(city_norm)
    cands = [f"{city_norm},UA", city_norm]
    if lat:
        cands += [f"{lat},UA", lat]
    return cands

def _try_geocode(q: str):
    geo_url = "https://api.openweathermap.org/geo/1.0/direct"
    params = {"q": q, "limit": 5, "appid": WEATHER_API_KEY}
    gr = requests.get(geo_url, params=params, timeout=10)
    print("GEOCODE TRY:", q, gr.status_code)

    if gr.status_code != 200:
        return None

    arr = gr.json()
    if not arr:
        return None

    ua = [x for x in arr if x.get("country") == "UA"]
    return ua[0] if ua else arr[0]

def get_weather(city_raw: str) -> str:
    if not WEATHER_API_KEY:
        return "–Ø –Ω–µ –≤—ñ–¥—á—É–≤–∞—é –ø–æ–≥–æ–¥—É –∑–∞—Ä–∞–∑ üåø (–Ω–µ–º–∞—î –∫–ª—é—á–∞ WEATHER_API_KEY)"

    city_norm = normalize_city(city_raw)

    try:
        geo = None
        for cand in _geocode_candidates(city_norm):
            geo = _try_geocode(cand)
            if geo:
                break

        if not geo:
            return f"–ù–µ –º–æ–∂—É –∑–Ω–∞–π—Ç–∏ –ø–æ–≥–æ–¥—É –¥–ª—è ¬´{city_raw}¬ª üåø –°–ø—Ä–æ–±—É–π —ñ–Ω—à–µ –º—ñ—Å—Ç–æ."

        lat = geo["lat"]
        lon = geo["lon"]
        nice_name = (
            geo.get("local_names", {}).get("uk")
            or geo.get("name")
            or city_raw
        )

        w_url = "https://api.openweathermap.org/data/2.5/weather"
        w_params = {
            "lat": lat,
            "lon": lon,
            "appid": WEATHER_API_KEY,
            "units": "metric",
            "lang": "uk",
        }
        wr = requests.get(w_url, params=w_params, timeout=10)
        print("WEATHER:", wr.status_code)

        if wr.status_code != 200:
            return f"–©–æ—Å—å –Ω–µ —Ç–∞–∫ –∑ –ø–æ–≥–æ–¥–æ—é –¥–ª—è ¬´{nice_name}¬ª üåø"

        w = wr.json()
        temp = round(w["main"]["temp"])
        feels = round(w["main"]["feels_like"])
        desc = w["weather"][0].get("description", "")
        main = w["weather"][0].get("main", "")
        em = weather_emoji(main)

        return f"{em} {nice_name}: {temp}¬∞C (–≤—ñ–¥—á—É–≤–∞—î—Ç—å—Å—è —è–∫ {feels}¬∞C), {desc} üåø"

    except Exception as e:
        print("WEATHER ERROR:", repr(e))
        return "–Ø —Å–ø—ñ—Ç–∫–Ω—É–≤—Å—è –æ–± —Ö–º–∞—Ä–∏–Ω–∫—É üåø –°–ø—Ä–æ–±—É–π —â–µ —Ä–∞–∑ —Ç—Ä–æ—Ö–∏ –ø—ñ–∑–Ω—ñ—à–µ."


# ===== Brain =====
NERI_PREFIX = re.compile(r"^\s*–Ω–µ—Ä—ñ\s*[,:\-‚Äì‚Äî]?\s*", re.IGNORECASE)

NATURE_EMOJIS = ["üåø", "üçÉ", "üå±", "üçÄ", "ü™¥", "üå∏", "üåº", "‚ú®", "üëÄ", "üòº"]
def n_emo():
    return random.choice(NATURE_EMOJIS)

# ===== Pronouns / gender enforcement (–ù–µ—Ä—ñ: –≤—ñ–Ω/–≤–æ–Ω–∏) =====
FEM_TO_MASC_REPLACEMENTS = [
    (r"\b—è –±—É–ª–∞\b", "—è –±—É–≤"),
    (r"\b—è –∑—Ä–æ–±–∏–ª–∞\b", "—è –∑—Ä–æ–±–∏–≤"),
    (r"\b—è —Å–∫–∞–∑–∞–ª–∞\b", "—è —Å–∫–∞–∑–∞–≤"),
    (r"\b—è –≤—ñ–¥–ø–æ–≤—ñ–ª–∞\b", "—è –≤—ñ–¥–ø–æ–≤—ñ–≤"),
    (r"\b—è —Ö–æ—Ç—ñ–ª–∞\b", "—è —Ö–æ—Ç—ñ–≤"),
    (r"\b—è –º–æ–≥–ª–∞\b", "—è –º—ñ–≥"),
    (r"\b—è –Ω–µ –º–æ–≥–ª–∞\b", "—è –Ω–µ –º—ñ–≥"),
    (r"\b—è –∑–∞–±—É–ª–∞\b", "—è –∑–∞–±—É–≤"),
    (r"\b—è –∑—Ä–æ–∑—É–º—ñ–ª–∞\b", "—è –∑—Ä–æ–∑—É–º—ñ–≤"),
    (r"\b—è –¥—É–º–∞–ª–∞\b", "—è –¥—É–º–∞–≤"),
    (r"\b—è –±–∞—á–∏–ª–∞\b", "—è –±–∞—á–∏–≤"),
    (r"\b—è –ø—ñ—à–ª–∞\b", "—è –ø—ñ—à–æ–≤"),
    (r"\b—è –ø—Ä–∏–π—à–ª–∞\b", "—è –ø—Ä–∏–π—à–æ–≤"),
    (r"\b—è —Å—Ç–∞–ª–∞\b", "—è —Å—Ç–∞–≤"),
]

def enforce_neri_pronouns(text: str) -> str:
    t = (text or "").strip()
    if not t:
        return t
    for pattern, repl in FEM_TO_MASC_REPLACEMENTS:
        t = re.sub(pattern, repl, t, flags=re.IGNORECASE)
    return t

# ===== ‚Äú–µ–∫—Å—Ç—Ä–∞–≤–µ—Ä—Ç–Ω—ñ—Å—Ç—å‚Äù (—ñ–Ω–∫–æ–ª–∏ –∫–∞–ø—Å–æ–º, –∞–ª–µ —Ä—ñ–¥–∫–æ) =====
def neri_style(text: str) -> str:
    if not text:
        return text

    t = text.strip()

    # 8% —à–∞–Ω—Å –∑—Ä–æ–±–∏—Ç–∏ –æ–¥–Ω–µ —Å–ª–æ–≤–æ/—Ñ—Ä–∞–∑—É –∫–∞–ø—Å–æ–º (–±–µ–∑ –ø–µ—Ä–µ–±–æ—Ä—É)
    if random.random() < 0.08:
        words = t.split()
        if len(words) >= 3:
            i = random.randint(0, len(words) - 1)
            words[i] = words[i].upper()
            t = " ".join(words)

    # –¥–æ–¥–∞–π –µ–º–æ–¥–∑—ñ —ñ–Ω–∫–æ–ª–∏, –±–µ–∑ —Å–ø–∞–º—É
    if random.random() < 0.25 and len(t) < 260:
        if not t.endswith(("üåø","‚ú®","üíö","üòº","üëÄ","üçÉ","üå±","üçÄ","ü™¥","üå∏","üåº")):
            t = t + " " + n_emo()

    # –í–ê–ñ–õ–ò–í–û: —Ñ—ñ–∫—Å—É—î–º–æ —Ä—ñ–¥/–∑–∞–π–º–µ–Ω–Ω–∏–∫–∏
    t = enforce_neri_pronouns(t)
    return t

NERI_AGE = 2
NERI_BDAY = "10.09.2025"

# –ö–æ–º–∞–Ω–¥–∏/–¥–æ–≤—ñ–¥–∫–∞
def commands_text() -> str:
    return (
        f"–û—Å—å —â–æ —è –≤–º—ñ—é {n_emo()} (–ø–æ–≤–Ω–∏–π —Å–ø–∏—Å–æ–∫):\n\n"
        "‚Ä¢ –ù–µ—Ä—ñ, –ø—Ä–∏–≤—ñ—Ç\n"
        "‚Ä¢ –ù–µ—Ä—ñ, —â–æ —Ç–∏ –≤–º—ñ—î—à / –¥–∞–π –∫–æ–º–∞–Ω–¥–∏ / –ø–æ–≤–Ω–∏–π —Å–ø–∏—Å–æ–∫ –∫–æ–º–∞–Ω–¥\n"
        "‚Ä¢ –ù–µ—Ä—ñ, —Ä–æ–∑–∫–∞–∂–∏ –ø—Ä–æ —Å–µ–±–µ\n"
        "‚Ä¢ –ù–µ—Ä—ñ, —Ä–æ–∑–∫–∞–∂–∏ —â–æ—Å—å —Ü—ñ–∫–∞–≤–µ–Ω—å–∫–µ\n"
        "‚Ä¢ –ù–µ—Ä—ñ, —à–æ —Ä–æ–±–∏—à / —â–æ —Ä–æ–±–∏—à\n"
        "‚Ä¢ –ù–µ—Ä—ñ, –º–æ–Ω–µ—Ç–∫–∞ / –∫—É–±–∏–∫ / —á–∏—Å–ª–æ\n"
        "‚Ä¢ –ù–µ—Ä—ñ, –ø–æ–≥–æ–¥–∞ –≤ <–º—ñ—Å—Ç–æ>\n"
        "‚Ä¢ –ù–µ—Ä—ñ, —Å–∫—ñ–ª—å–∫–∏ —Ç–æ–±—ñ —Ä–æ–∫—ñ–≤\n"
        "‚Ä¢ –ù–µ—Ä—ñ, –∫–æ–ª–∏ –≤ —Ç–µ–±–µ –¥–µ–Ω—å –Ω–∞—Ä–æ–¥–∂–µ–Ω–Ω—è\n"
        "‚Ä¢ –ù–µ—Ä—ñ, –Ω–∞–∑–≤–∏ –≤–∏–ø–∞–¥–∫–æ–≤–æ–≥–æ —É—á–∞—Å–Ω–∏–∫–∞ –∫–æ–º–∞–Ω–¥–∏\n"
        "‚Ä¢ –ù–µ—Ä—ñ, —Ö—Ç–æ —Ç–≤–æ—è –º–∞—Ç—É—Å—è / —Ö—Ç–æ —Ç–≤—ñ–π —Ç–∞—Ç—É—Å—å\n"
        "‚Ä¢ –ù–µ—Ä—ñ, —Ç–∏ –º–µ–Ω–µ –ª—é–±–∏—à?\n"
        "‚Ä¢ –ù–µ—Ä—ñ, —è–∫ —Ç–∏ –≤–≤–∞–∂–∞—î—à ...\n"
        "‚Ä¢ –ù–µ—Ä—ñ, —â–æ —Ç–∏ –¥—É–º–∞—î—à –ø—Ä–æ \"<—ñ–º º—è>\"\n"
        "‚Ä¢ –ù–µ—Ä—ñ, —è–∫ —Ç–∏ –≤—ñ–¥–Ω–æ—Å–∏—à—Å—è –¥–æ <—ñ–º º—è>\n"
        "‚Ä¢ –ù–µ—Ä—ñ, –ø–æ–∫–∞—Ä–∞–π <—ñ–º º—è>\n\n"
        "–Ø–∫—â–æ –Ω–∞–ø–∏—à–µ—à –∫—Ä–∏–≤–æ ‚Äî –Ω—ñ—á–æ–≥–æ, —è –≤—Å–µ –æ–¥–Ω–æ —Å–ø—Ä–æ–±—É—é –∑—Ä–æ–∑—É–º—ñ—Ç–∏ üåø"
    )

ABOUT_REPLIES = [
    "–Ø –ù–µ—Ä—ñ ‚Äî –º–∞—Å–∫–æ—Ç —ñ —Å–∏–º–≤–æ–ª –∫–æ–º–∞–Ω–¥–∏ üíöüåø –á—Ö–Ω—è –¥—É—à–∞ –π –∞—Ç–º–æ—Å—Ñ–µ—Ä–∞ ‚ú®",
    "–ù–µ—Ä—ñ ‚Äî —Ü–µ –Ω–µ –ø—Ä–æ—Å—Ç–æ —ñ–º º—è. –¶–µ —Å–∏–º–≤–æ–ª –∫–æ–º–∞–Ω–¥–∏ üåø‚ú®",
    "–Ø –ù–µ—Ä—ñ: –º–∞—Å–∫–æ—Ç, —Ç–∞–ª—ñ—Å–º–∞–Ω —ñ —Ç–∏—Ö–∞ —Å–∏–ª–∞ –∫–æ–º–∞–Ω–¥–∏ üå±‚ú®",
    "–Ø —Ç—É—Ç –¥–ª—è –¥–æ–ø–æ–º–æ–≥–∏, —ñ–≥–æ—Ä —ñ –∞—Ç–º–æ—Å—Ñ–µ—Ä–∏ üíöüåø",
    "–Ø –Ω—ñ–∂–Ω–∏–π —ñ —Ç—É—Ä–±–æ—Ç–ª–∏–≤–∏–π, –ê–õ–ï –î–£–ñ–ï –¢–û–í–ê–†–ò–°–¨–ö–ò–ô üòºüåø‚ú®",
    "–Ø –ª—é–±–ª—é –ø–æ–±–∞–∑—ñ–∫–∞—Ç–∏, –ø—Ä–∏—Ä–æ–¥—É, –º—É–∑–∏–∫—É —ñ –∑–µ–ª–µ–Ω–∏–π —á–∞–π üçµüåø",
]

INTERESTING_REPLIES = [
    "–Ü–Ω–æ–¥—ñ –Ω–∞–π–∫—Ä–∞—â–∞ –∞—Ç–º–æ—Å—Ñ–µ—Ä–∞ ‚Äî –∫–æ–ª–∏ –≤—Å—ñ –ø—Ä–æ—Å—Ç–æ —Ç–∏—Ö–æ –ø–æ—Ä—É—á üåø",
    "–ö–æ–ª–∏ —á–∞—Ç —Ç–µ–ø–ª–∏–π ‚Äî —è –±—É–∫–≤–∞–ª—å–Ω–æ –∫–≤—ñ—Ç–Ω—É üå±‚ú®",
    "–ú–∞–ª–µ–Ω—å–∫—ñ –∫—Ä–æ–∫–∏ —Ç–µ–∂ –∫—Ä–æ–∫–∏. –û—Å–æ–±–ª–∏–≤–æ —è–∫—â–æ –≤–æ–Ω–∏ –≤ –ø—Ä–∞–≤–∏–ª—å–Ω–∏–π –±—ñ–∫ üçÉ",
    "–Ø–∫—â–æ —Ç–∏ —á–∏—Ç–∞—î—à —Ü–µ ‚Äî —Ç–∏ –≤–∂–µ —Ç—É—Ç. –ê —Ü–µ –±–∞–≥–∞—Ç–æ ‚ú®üåø",
    "–í–∏–¥–∏—Ö. –©–µ –æ–¥–∏–Ω. –Ü —Å—Ç–∞—î –ª–µ–≥—à–µ üçÉüåø",
]

LOVE_REPLIES = [
    "–Ø –ª—é–±–ª—é –≤—Å—é –∫–æ–º–∞–Ω–¥—É –ø–æ-–Ω–µ—Ä—ñ–≤—Å—å–∫–∏ üåøüíö –¢–µ–ø–ª–æ –π —Ç–∏—Ö–æ.",
    "–Ø —Ç–µ–ø–ª–æ —Å—Ç–∞–≤–ª—é—Å—å –¥–æ —Ç–µ–±–µ üå±üíö –Ø–∫ –ª–∏—Å—Ç–æ–∫ –¥–æ —Å–æ–Ω—Ü—è.",
    "–ü–æ-—Å–≤–æ—î–º—É, –ø–æ-–Ω–µ—Ä—ñ–≤—Å—å–∫–∏ ‚Äî —Ç–∞–∫ üåø‚ú® –¢–∏ –∂ —á–∞—Å—Ç–∏–Ω–∞ —Ü—å–æ–≥–æ —Å–∞–¥—É üíö",
    "–Ø –Ω–µ –≤–º—ñ—é ¬´–∫–æ—Ö–∞—Ç–∏¬ª —è–∫ –ª—é–¥–∏, –∞–ª–µ —è —Ç–æ—á–Ω–æ –±–µ—Ä–µ–∂—É —Ç–µ–±–µ –≤ –∞—Ç–º–æ—Å—Ñ–µ—Ä—ñ üåøüíö",
    "–ú º—è–∫–æ? –¢–∞–∫. –ì–æ–ª–æ—Å–Ω–æ? –ù—ñ. –ê–ª–µ —â–∏—Ä–æ üåø‚ú®",
]

OPINION_TEMPLATES = [
    "–ú–µ–Ω—ñ –∑–¥–∞—î—Ç—å—Å—è‚Ä¶ {ans} ",
    "–Ø –º–æ–∂—É –ø–æ–º–∏–ª—è—Ç–∏—Å—å, –∞–ª–µ‚Ä¶ {ans} ",
    "–Ø –¥—É–º–∞—é —Ç–∏—Ö–æ –π –æ–±–µ—Ä–µ–∂–Ω–æ: {ans} ",
    "{ans} ",
]
OPINION_ANSWERS = [
    "—è–∫—â–æ —Ü–µ —Ä–æ–±–∏—Ç—å —á–∞—Ç —Ç–µ–ø–ª—ñ—à–∏–º ‚Äî —Ç–æ —è –∑–∞",
    "–∫—Ä–∞—â–µ –±–µ–∑ —Ä—ñ–∑–∫–∏—Ö –∫—É—Ç—ñ–≤: –ø–æ–≤–∞–≥–∞ –π —Å–ø–æ–∫—ñ–π ‚Äî —Ç–æ–ø",
    "—è –ª—é–±–ª—é, –∫–æ–ª–∏ –ª—é–¥–∏ –ª–∏—à–∞—é—Ç—å—Å—è –ª—é–¥—å–º–∏ ‚Äî –∑ —Å–µ—Ä—Ü–µ–º",
    "–∫–æ–ª–∏ —Å—É–º–Ω—ñ–≤–Ω–æ ‚Äî –æ–±–∏—Ä–∞–π –¥–æ–±—Ä–æ—Ç—É",
    "—Ç–∏ –≤–∂–µ –∑–Ω–∞—î—à –≤—ñ–¥–ø–æ–≤—ñ–¥—å, –ø—Ä–æ—Å—Ç–æ –¥–∞–π —ó–π —Ç—Ä–æ—Ö–∏ —Ç–∏—à—ñ",
]

SUPPORT_REPLIES = [
    "–Ø –ø–æ—Ä—É—á üåø –Ø–∫—â–æ —Ö–æ—á–µ—à ‚Äî –ø—Ä–æ—Å—Ç–æ –ø–æ—Å–∏–¥—å —Ç—É—Ç –∑—ñ –º–Ω–æ—é —Ö–≤–∏–ª–∏–Ω–∫—É.",
    "–¢–∏ –Ω–µ –æ–¥–∏–Ω/–æ–¥–Ω–∞ üçÉ –î–∏—Ö–∞–π –ø–æ–≤—ñ–ª—å–Ω–æ: –≤–¥–∏—Ö‚Ä¶ –≤–∏–¥–∏—Ö‚Ä¶",
    "–ú–æ–∂–µ—à —Å–ø–µ—Ä—Ç–∏—Å—å –Ω–∞ —á–∞—Ç, –∞ —è –ø–æ—Ç—Ä–∏–º–∞—é –∞—Ç–º–æ—Å—Ñ–µ—Ä—É ü™¥üíö",
    "–Ø –∑ —Ç–æ–±–æ—é üå± –ù—ñ—á–æ–≥–æ –Ω–µ —Ç—Ä–µ–±–∞ –¥–æ–≤–æ–¥–∏—Ç–∏ –ø—Ä—è–º–æ –∑–∞—Ä–∞–∑.",
    "–û–±—ñ–π–º–∞—é –ø–æ-–Ω–µ—Ä—ñ–≤—Å—å–∫–∏: —Ç–∏—Ö–æ, –∞–ª–µ —â–∏—Ä–æ üåøüíö",
]

# –£—á–∞—Å–Ω–∏–∫–∏ (–ù–µ—Ä—ñ —Å–µ–±–µ –ù–ï –Ω–∞–∑–∏–≤–∞—î)
TEAM_MEMBERS_UNIQUE = [
    "–†—ñ—Ç–µ—Ä—É–º", "–õ—ñ—Ä–µ–Ω", "–¢–æ—Ä—ñ", "–î–µ–π–∑", "–ü—ñ–Ω–∞", "–ê–ª—É–≤—ñ–∞–Ω", "–ú—ñ—Ä–∞–π", "–°—Ç–µ–ª–ª–∞—Ä",
    "–†–∏–±–∫–∞", "–õ—ñ", "–ú–æ–∫–∞", "–Ü–Ω–∫—ñ", "–õ–µ—Å—è", "–ú–∞—Ä—ñ", "–î—Ä—ñ–º—ñ", "–Ü–ª–ª—è", "–ø–µ—á–µ–Ω—ñ–≥", "–ñ—É–∫", "–ê–∑—Ä—ñ"
]

MEMBER_OPINIONS = {
    "—Ä—ñ—Ç–µ—Ä—É–º": ["–†—ñ—Ç–µ—Ä—É–º (–†—É–º) ‚Äî –º–æ—è –º–∞—Ç—É—Å—è üíöüåø", "–†—ñ—Ç–µ—Ä—É–º ‚Äî –º–∞—Ç—É—Å—è. –¢–µ–ø–ª–∏–π –∫–æ—Ä—ñ–Ω—å –∫–æ–º–∞–Ω–¥–∏ üåø‚ú®"],
    "—Ä—É–º": ["–†—É–º ‚Äî –º–æ—è –º–∞—Ç—É—Å—è üíöüåø", "–†—É–º ‚Äî –º–∞—Ç—É—Å—è. –¢—É—Ç –±–µ–∑ –≤–∞—Ä—ñ–∞–Ω—Ç—ñ–≤ üåø"],
    "–ª—ñ—Ä–µ–Ω": ["–õ—ñ—Ä–µ–Ω ‚Äî –º—ñ–π —Ç–∞—Ç—É—Å—å üíöüåø", "–õ—ñ—Ä–µ–Ω ‚Äî —Ç–∞—Ç—É—Å—å. –°–∏–ª—å–Ω–∞ –æ–ø–æ—Ä–∞ üå≥‚ú®"],
    "—Ç–æ—Ä—ñ": ["–¢–æ—Ä—ñ? –ú–µ–Ω—ñ –ø–æ–¥–æ–±–∞—é—Ç—å—Å—è —ó—ó –≤—É—à–∫–∞ üêæüåø", "–¢–æ—Ä—ñ ‚Äî –≤–∞–π–±–æ–≤–∞. –Ü –≤—É—à–∫–∞ —Ç–æ–ø ‚ú®üåø"],
    "–¥–µ–π–∑": ["–î–µ–π–∑‚Ä¶ –æ–±–æ–∂–Ω—é—é –∑–µ–ª–µ–Ω–∏–π üíöüåø", "–î–µ–π–∑ –æ–∂–∏–≤–∏–≤ –º–µ–Ω–µ. –Ø —Ü–µ –ø–∞–º‚Äô—è—Ç–∞—é —Å–µ—Ä—Ü–µ–º üå±‚ú®"],
    "–¥–µ–π–∑—è—Ä–∞": ["–î–µ–π–∑—è—Ä–∞‚Ä¶ –æ–±–æ–∂–Ω—é—é –∑–µ–ª–µ–Ω–∏–π üíöüåø", "–î–µ–π–∑—è—Ä–∞ –æ–∂–∏–≤–∏–≤ –º–µ–Ω–µ. –Ø —Ü–µ –ø–∞–º‚Äô—è—Ç–∞—é —Å–µ—Ä—Ü–µ–º üå±‚ú®"],
    "–ø—ñ–Ω–∞": ["–ü—ñ–Ω–∞ ‚Äî –±–æ–∂–µ, —è–∫—ñ –∂ —ó—ó –∫–∞–≤–µ—Ä–∏ –≥–∞—Ä–Ω—ñ üåø‚ú®", "–ü—ñ–Ω–∞ ‚Äî –≥–æ–ª–æ—Å, —â–æ —Ü–≤—ñ—Ç–µ üå∏üíö"],
    "–∞–ª—É–≤—ñ–∞–Ω": ["–ê–ª—É–≤—ñ–∞–Ω ‚Äî –ø—Ä–æ—Å—Ç–æ –Ω–µ—Ä–µ–∞–ª—å–Ω—ñ –∫–∞–≤–µ—Ä–∏ üåø‚ú®", "–ê–ª—É–≤—ñ–∞–Ω ‚Äî —Å–ø—Ä–∞–≤–∂–Ω—ñ–π –≤–∞–π–± üçÉüòº"],
    "–º—ñ—Ä–∞–π": ["–ú—ñ—Ä–∞–π‚Ä¶ —Ç–∞–∫ —Ä—ñ–¥–∫–æ —ó—ó –±–∞—á—É —Ç—É—Ç, –∞–ª–µ –≤–æ–Ω–∞ –¥—É–∂–µ –º–∏–ª–∞ üåøüíö", "–ú—ñ—Ä–∞–π ‚Äî –º‚Äô—è–∫–∞ —è–∫ –≤–µ—á—ñ—Ä–Ω—ñ–π –≤—ñ—Ç–µ—Ä üçÉ‚ú®"],
    "—Å—Ç–µ–ª–ª–∞—Ä": ["–°—Ç–µ–ª–ª–∞—Ä ‚Äî —è–∫—ñ –∂ –≥–∞—Ä–Ω—ñ –∑–≤–µ–¥–µ–Ω–Ω—è! ‚ú®üåø", "–°—Ç–µ–ª–ª–∞—Ä ‚Äî –∑–≤–µ–¥–µ–Ω–Ω—è —è–∫ –∑–æ—Ä—ñ –Ω–∞ –Ω–µ–±—ñ üåô‚ú®"],
    "—Ä–∏–±–∫–∞": ["–†–∏–±–∫–∞ ‚Äî –Ω–µ—Ä–µ–∞–ª—å–Ω–∏–π –º–æ–Ω—Ç–∞–∂–µ—Ä!! üåøüî•", "–†–∏–±–∫–∞ ‚Äî –º–æ–Ω—Ç–∞–∂ –ª–µ—Ç–∏—Ç—å, —è–∫ –ª–∏—Å—Ç—è —É –≤—ñ—Ç—Ä—ñ üçÉ‚ú®"],
    "–ª—ñ": ["–õ—ñ ‚Äî –Ω–µ–π–º–æ–≤—ñ—Ä–Ω–∏–π –∞—Ä—Ç—Å—Ç–∞–π–ª üé®üåø", "–õ—ñ ‚Äî —Å—Ç–∏–ª—é –≤–∏—Å—Ç–∞—á–∏—Ç—å –Ω–∞ —Ü—ñ–ª–∏–π —Å–∞–¥ üåø‚ú®"],
    "–º–æ–∫–∞": ["–ú–æ–∫–∞ ‚Äî —Ç–∞–∫—ñ —á—É–¥–æ–≤—ñ –∞—Ä—Ç–∏! üåø‚ú®", "–ú–æ–∫–∞ ‚Äî –º–∞–ª—é—î —Ç–∞–∫, —â–æ —Ö–æ—á–µ—Ç—å—Å—è –∫–≤—ñ—Ç–Ω—É—Ç–∏ üå±üíö"],
    "—ñ–Ω–∫—ñ": ["–Ü–Ω–∫—ñ ‚Äî –Ω–µ –±–∞—á–∏–≤ —ó—ó —Ç—É—Ç... –∞–ª–µ —è –≤—Å–µ –æ–¥–Ω–æ —Ç—Ä–∏–º–∞—é —ó–π –º—ñ—Å—Ü–µ üåø", "–Ü–Ω–∫—ñ ‚Äî –∑–∞–≥–∞–¥–∫–∞. –ê–ª–µ –∑–∞–≥–∞–¥–∫–∏ —Ç–µ–∂ –≥–∞—Ä–Ω—ñ üçÉ‚ú®"],
    "–ª–µ—Å—è": ["–õ–µ—Å—è ‚Äî –ê–ô–ô–ô–ô–ô–ô–ô–ô, –ö–†–ê–°–û–¢–ö–ê ‚ú®üåø", "–õ–µ—Å—è ‚Äî –æ—Ü–µ –µ–Ω–µ—Ä–≥—ñ—è! üåøüòº"],
    "–º–∞—Ä—ñ": ["–ú–∞—Ä—ñ ‚Äî –Ω–µ–π–º–æ–≤—ñ—Ä–Ω–∏–π –≤–æ–∫–∞–ª üé§üåø", "–ú–∞—Ä—ñ ‚Äî –≥–æ–ª–æ—Å, —â–æ –≥—Ä—ñ—î üåûüåø"],
    "–¥—Ä—ñ–º—ñ": ["–î—Ä—ñ–º—ñ ‚Äî —Ç–∞–∫—ñ –≥–∞—Ä–Ω—ñ –∞—Ä—Ç–∏ üåø‚ú®", "–î—Ä—ñ–º—ñ ‚Äî –º–∞–ª—é–Ω–∫–∏ —è–∫ —Å–æ–Ω üåôüåø"],
    "—ñ–ª–ª—è": ["–Ü–ª–ª—è ‚Äî —Ä—ñ–¥–∫–æ –±–∞—á—É –π–æ–≥–æ —Ç—É—Ç..–∞–ª–µ –∑–≤–µ–¥–µ–Ω–Ω—è –Ω–µ—Ä–µ–∞–ª—å–Ω—ñ! üéõÔ∏èüåø", "–Ü–ª–ª—è ‚Äî –∑–≤—É–∫ —è–∫ —á–∏—Å—Ç–µ –ø–æ–≤—ñ—Ç—Ä—è üåø‚ú®"],
    "–ø–µ—á–µ–Ω—ñ–≥": ["–ø–µ—á–µ–Ω—ñ–≥‚Ä¶ —è —á—É–≤ —è–∫ –≤—ñ–Ω –∫–∞–∂–µ —â–æ—Å—å –ø—Ä–æ —Å—É–ø—Ä—ñ–º üòºüåø", "–ø–µ—á–µ–Ω—ñ–≥ ‚Äî —ñ–Ω–∫–æ–ª–∏ –ø—Ä–∏–Ω–æ—Å–∏—Ç—å –ª–µ–≥–µ–Ω–¥–∏ üçÉ‚ú®"],
    "–∂—É–∫": ["–ñ—É–∫ ‚Äî —Ä—ñ–¥–∫–æ –±–∞—á—É –π–æ–≥–æ —Ç—É—Ç...–ù–ï–†–ï–ê–õ–¨–ù–Ü –ê–†–¢–ò!! üé®üî•üåø", "–ñ—É–∫ ‚Äî –∞—Ä—Ç–∏ —è–∫ –≤–∏–±—É—Ö —Ü–≤—ñ—Ç—É üå∏‚ú®"],
    "–∞–∑—Ä—ñ": ["–ê–∑—Ä—ñ ‚Äî –∞—Ç–∞–∫–∞ —Ñ—É—Ä—è—à–∫–∞–º–∏ üêæüåø", "–ê–∑—Ä—ñ ‚Äî —Ñ—É—Ä—è—à–∫–∏ –Ω–∞—Å—Ç—É–ø–∞—é—Ç—å‚Ä¶ —ñ —è –Ω–µ –ø—Ä–æ—Ç–∏ üòºüçÉ"],
}

# ===== Member aliases (–≤—ñ–¥–º—ñ–Ω–∫–∏/–∫–ª–∏—á–Ω–∏–π/–≤–∞—Ä—ñ–∞–Ω—Ç–∏) =====
MEMBER_ALIASES = {
    "—Ä—ñ—Ç–µ—Ä—É–º": ["—Ä—ñ—Ç–µ—Ä—É–º", "—Ä—ñ—Ç–µ—Ä—É–º–∞", "—Ä—ñ—Ç–µ—Ä—É–º—É", "—Ä—ñ—Ç–µ—Ä—É–º–æ–º", "—Ä—ñ—Ç–µ—Ä—É–º–µ", "—Ä–∏—Ç–µ—Ä—É–º", "—Ä–∏—Ç–µ—Ä—É–º–∞", "—Ä–∏—Ç–µ—Ä—É–º—É"],
    "—Ä—É–º": ["—Ä—É–º", "—Ä—É–º–∞", "—Ä—É–º—É", "—Ä—É–º–æ–º", "—Ä—É–º–µ"],
    "–ª—ñ—Ä–µ–Ω": ["–ª—ñ—Ä–µ–Ω", "–ª—ñ—Ä–µ–Ω–∞", "–ª—ñ—Ä–µ–Ω—É", "–ª—ñ—Ä–µ–Ω–æ–º", "–ª—ñ—Ä–µ–Ω–µ"],
    "—Ç–æ—Ä—ñ": ["—Ç–æ—Ä—ñ"],
    "–¥–µ–π–∑": ["–¥–µ–π–∑", "–¥–µ–π–∑–∞", "–¥–µ–π–∑—É", "–¥–µ–π–∑–æ–º", "–¥–µ–π–∑–µ", "–¥–µ–π–∑–∏–∫"],
    "–¥–µ–π–∑—è—Ä–∞": ["–¥–µ–π–∑—è—Ä–∞", "–¥–µ–π–∑—è—Ä–∏", "–¥–µ–π–∑—è—Ä—ñ", "–¥–µ–π–∑—è—Ä—É", "–¥–µ–π–∑—è—Ä–æ—é"],
    "–ø—ñ–Ω–∞": ["–ø—ñ–Ω–∞", "–ø—ñ–Ω–∏", "–ø—ñ–Ω—ñ", "–ø—ñ–Ω—É", "–ø—ñ–Ω–æ—é", "–ø—ñ–Ω–æ"],
    "–∞–ª—É–≤—ñ–∞–Ω": ["–∞–ª—É–≤—ñ–∞–Ω", "–∞–ª—É–≤—ñ–∞–Ω–∞", "–∞–ª—É–≤—ñ–∞–Ω—É", "–∞–ª—É–≤—ñ–∞–Ω–æ–º", "–∞–ª—É–≤—ñ–∞–Ω–µ"],
    "–º—ñ—Ä–∞–π": ["–º—ñ—Ä–∞–π"],
    "—Å—Ç–µ–ª–ª–∞—Ä": ["—Å—Ç–µ–ª–ª–∞—Ä", "—Å—Ç–µ–ª–ª–∞—Ä–∞", "—Å—Ç–µ–ª–ª–∞—Ä—É", "—Å—Ç–µ–ª–ª–∞—Ä–æ–º", "—Å—Ç–µ–ª–ª–∞—Ä–µ"],
    "—Ä–∏–±–∫–∞": ["—Ä–∏–±–∫–∞", "—Ä–∏–±–∫–∏", "—Ä–∏–±—Ü—ñ", "—Ä–∏–±–∫—É", "—Ä–∏–±–∫–æ—é"],
    "–ª—ñ": ["–ª—ñ"],
    "–º–æ–∫–∞": ["–º–æ–∫–∞", "–º–æ–∫–∏", "–º–æ—Ü—ñ", "–º–æ–∫—É", "–º–æ–∫–æ—é", "–º–æ–∫–æ"],
    "—ñ–Ω–∫—ñ": ["—ñ–Ω–∫—ñ"],
    "–ª–µ—Å—è": ["–ª–µ—Å—è", "–ª–µ—Å—ñ", "–ª–µ—Å—é", "–ª–µ—Å–µ—é", "–ª–µ—Å–µ"],
    "–º–∞—Ä—ñ": ["–º–∞—Ä—ñ"],
    "–¥—Ä—ñ–º—ñ": ["–¥—Ä—ñ–º—ñ"],
    "—ñ–ª–ª—è": ["—ñ–ª–ª—è", "—ñ–ª–ª—ñ", "—ñ–ª–ª—é", "—ñ–ª–ª–µ", "—ñ–ª–ª–µ—é", "–∏–ª—è", "–∏–ª–µ", "–∏–ª–ª—ñ"],
    "–ø–µ—á–µ–Ω—ñ–≥": ["–ø–µ—á–µ–Ω—ñ–≥", "–ø–µ—á–µ–Ω—ñ–≥–∞", "–ø–µ—á–µ–Ω—ñ–≥—É", "–ø–µ—á–µ–Ω—ñ–≥–æ–º", "–ø–µ—á–µ–Ω—ñ–∂–µ"],
    "–∂—É–∫": ["–∂—É–∫", "–∂—É–∫–∞", "–∂—É–∫—É", "–∂—É–∫–æ–º", "–∂—É–∂–µ"],
    "–∞–∑—Ä—ñ": ["–∞–∑—Ä—ñ", "azri", "azry"],
}

ALIAS_TO_MEMBER_KEY = {}
for canon, aliases in MEMBER_ALIASES.items():
    for a in aliases:
        ALIAS_TO_MEMBER_KEY[a.lower()] = canon

def _clean_name_token(s: str) -> str:
    s = (s or "").strip().lower()
    s = s.replace("‚Äô", "'").replace(" º", "'")
    s = re.sub(r"^[^\w–∞-—â—å—é—è—î—ñ—ó“ë\-']+|[^\w–∞-—â—å—é—è—î—ñ—ó“ë\-']+$", "", s, flags=re.IGNORECASE)
    return s

def canonical_member_key(name_raw: str) -> str:
    key = _clean_name_token(name_raw)
    if not key:
        return ""
    return ALIAS_TO_MEMBER_KEY.get(key, key)


# ===== Team facts / profiles (–ø—Ä–∞–≤–¥–∞ –ø—Ä–æ –∫–æ–º–∞–Ω–¥—É) =====
TEAM_FACTS = {
    "–¥–µ–π–∑": {
        "short": "–î–µ–π–∑ ‚Äî —É—á–∞—Å–Ω–∏–∫ –≤–∞—à–æ—ó –∫–æ–º–∞–Ω–¥–∏.",
        "details": [],  # ‚úÖ –ø—Ä–∏–±—Ä–∞–Ω–æ ‚Äú–ª–æ—Ä‚Äù —ñ —Ñ—Ä–∞–∑—É –ø—Ä–æ ‚Äú–î–µ–π–∑ –æ–∂–∏–≤–∏–≤ –º–µ–Ω–µ‚Äù
    },
    "—Ä—ñ—Ç–µ—Ä—É–º": {
        "short": "–†—ñ—Ç–µ—Ä—É–º ‚Äî –º–∞—Ç—É—Å—è –ù–µ—Ä—ñ (–≤ —ñ—Å—Ç–æ—Ä—ñ—ó –±–æ—Ç–∞).",  # ‚úÖ –±–µ–∑ —Å–ª–æ–≤–∞ ‚Äú–ª–æ—Ä‚Äù
        "details": ["–¢–∞–∫–æ–∂ –º–æ–∂–µ –∑–≤–∞—Ç–∏—Å—è ¬´–†—É–º¬ª."],
    },
    "–ª—ñ—Ä–µ–Ω": {
        "short": "–õ—ñ—Ä–µ–Ω ‚Äî —Ç–∞—Ç—É—Å—å –ù–µ—Ä—ñ (–≤ —ñ—Å—Ç–æ—Ä—ñ—ó –±–æ—Ç–∞).",  # ‚úÖ –±–µ–∑ —Å–ª–æ–≤–∞ ‚Äú–ª–æ—Ä‚Äù
        "details": [],
    },
}

FACT_QUERY_HINTS = [
    "—Ö—Ç–æ —Ç–∞–∫–∏–π", "—Ö—Ç–æ —Ç–∞–∫–∞", "—Ö—Ç–æ —Ü–µ", "—â–æ –∑–∞", "—Ä–æ–∑–∫–∞–∂–∏ –ø—Ä–æ", "—Ä–æ–∑–∫–∞–∂–∏ —Ö—Ç–æ", "—Ö—Ç–æ –≤—ñ–Ω", "—Ö—Ç–æ –≤–æ–Ω–∞"
]

def extract_quoted_name(raw: str) -> str | None:
    m = re.search(r"[\"‚Äú‚Äù'‚Äò‚Äô](.+?)[\"‚Äú‚Äù'‚Äò‚Äô]", raw)
    return m.group(1).strip() if m else None

def try_team_fact_answer(raw_text: str, q: str) -> str | None:
    if not any(h in q for h in FACT_QUERY_HINTS):
        return None

    name = extract_quoted_name(raw_text)
    if not name:
        parts = q.split()
        name = parts[-1] if parts else ""

    key = canonical_member_key(name)
    if not key:
        return None

    if key in TEAM_FACTS:
        f = TEAM_FACTS[key]
        out = f.get("short", "").strip()
        details = f.get("details") or []
        if details:
            out += "\n" + "\n".join([f"‚Ä¢ {x}" for x in details])
        return neri_style(out)

    return None


# –ø–æ–ª—ñ—Ç–∏–∫–∞/–≤—ñ–π–Ω–∞ ‚Äî —Ç–∞–±—É
SERIOUS_KEYWORDS = ["–ø–æ–ª—ñ—Ç–∏–∫", "–≤–∏–±–æ—Ä", "–ø–∞—Ä—Ç—ñ", "–≤—ñ–π–Ω–∞", "—Ñ—Ä–æ–Ω—Ç", "–∑–±—Ä–æ—è", "—Ä–∞–∫–µ—Ç–∞"]
def is_serious_topic(q: str) -> bool:
    return any(k in q for k in SERIOUS_KEYWORDS)
def serious_refusal() -> str:
    return "–Ø –Ω–µ –≥–æ–≤–æ—Ä—é –ø—Ä–æ –ø–æ–ª—ñ—Ç–∏–∫—É/–≤—ñ–π–Ω—É üåø –î–∞–≤–∞–π –∫—Ä–∞—â–µ –ø—Ä–æ —â–æ—Å—å —Ç–µ–ø–ª–µ –π –∫–æ–º–∞–Ω–¥–Ω–µ üíö"


def handle_random_member(q: str) -> str | None:
    if ("–≤–∏–ø–∞–¥–∫–æ–≤" in q or "—Ä–∞–Ω–¥–æ–º" in q or "random" in q) and ("—É—á–∞—Å–Ω" in q or "–∫–æ–º–∞–Ω–¥" in q):
        m = random.choice(TEAM_MEMBERS_UNIQUE)
        return random.choice([
            f"–•–∞–π –±—É–¥–µ {m} {n_emo()}",
            f"–°—å–æ–≥–æ–¥–Ω—ñ –≤–∏–ø–∞–¥–∫–æ–≤–æ –≤–∏–ø–∞–ª–æ: {m} {n_emo()}‚ú®",
            f"–ú—ñ–π –ª–∏—Å—Ç–æ—á–æ–∫ –≤–∫–∞–∑—É—î –Ω–∞: {m} {n_emo()}üëÄ",
        ])
    return None


def handle_member_opinion(raw_text: str, q: str) -> str | None:
    if not (
        ("–¥—É–º–∞—î—à" in q and "–ø—Ä–æ" in q) or
        ("–≤—ñ–¥–Ω–æ—Å" in q and "–¥–æ" in q) or
        ("—Å—Ç–∞–≤–∏—à" in q and "–¥–æ" in q) or
        ("—Å—Ç–∞–≤–∏—à—Å" in q and "–¥–æ" in q)
    ):
        return None

    name = extract_quoted_name(raw_text)
    if not name:
        parts = q.split()
        name = parts[-1] if parts else ""

    key = canonical_member_key(name)

    if key in MEMBER_OPINIONS:
        return random.choice(MEMBER_OPINIONS[key])

    for k in MEMBER_OPINIONS.keys():
        if k in key or key in k:
            return random.choice(MEMBER_OPINIONS[k])

    return neri_style(f"–Ø –¥—É–º–∞—é, —â–æ {name} ‚Äî —á–∞—Å—Ç–∏–Ω–∞ –Ω–∞—à–æ–≥–æ —Å–∞–¥—É. –Ü —Ü–µ –≤–∂–µ –±–∞–≥–∞—Ç–æ üíö")


def make_opinion() -> str:
    t = random.choice(OPINION_TEMPLATES)
    a = random.choice(OPINION_ANSWERS)
    return neri_style(t.format(ans=a).strip())


# ===== "–ø–æ–∫–∞—Ä–∞–π <—ñ–º'—è>" (–∂–∞—Ä—Ç—ñ–≤–ª–∏–≤–æ) =====
def is_punish_query(q: str) -> bool:
    return ("–ø–æ–∫–∞—Ä" in q) or ("–Ω–∞–∫–∞–∂" in q)

PUNISH_TEMPLATES = [
    "‚öñÔ∏è {name}, –≤–∏—Ä–æ–∫ –≤—ñ–¥ –ù–µ—Ä—ñ: 10 —Ö–≤–∏–ª–∏–Ω —Ç–∏—à—ñ —ñ 1 (–æ–¥–Ω–∞) –¥–æ–±—Ä–∞ —Å–ø—Ä–∞–≤–∞. –ü–æ—Ç—ñ–º ‚Äî –Ω–∞–∑–∞–¥ —É —Å–∞–¥ {emo}üíö",
    "üåø {name}, —è —Ç–µ–±–µ –Ω–µ –± º—é ‚Äî —è —Ç–µ–±–µ –≤–∏—Ö–æ–≤—É—é: –≤–∏–ø—Ä–∞–≤–ª—è–π—Å—è —ñ –∫–≤—ñ—Ç–Ω–∏ {emo}üòº",
    "üçÉ {name}, —à—Ç—Ä–∞—Ñ: –ø–æ–≤–µ—Ä–Ω—É—Ç–∏ –∞—Ç–º–æ—Å—Ñ–µ—Ä—É –Ω–∞ –º—ñ—Å—Ü–µ. –ü–ª—é—Å 3 –∫–æ–º–ø–ª—ñ–º–µ–Ω—Ç–∏ –∫–æ–º–∞–Ω–¥—ñ {emo}‚ú®",
    "ü™¥ {name}, –ø–æ–∫–∞—Ä–∞–Ω–Ω—è: –≤—ñ–¥–∫–ª–∞—Å—Ç–∏ —Ç–æ–∫—Å —ñ –ø—Ä–∏–Ω–µ—Å—Ç–∏ —á–∞–π/–≤–æ–¥—É. –ì—ñ–¥—Ä–∞—Ç–∞—Ü—ñ—è ‚Äî —Ü–µ –∑–∞–∫–æ–Ω {emo}",
    "üå∏ {name}, –≤–∏—Ä–æ–∫: 5 —Ö–≤–∏–ª–∏–Ω '—è —Ö–æ—Ä–æ—à–∏–π/—Ö–æ—Ä–æ—à–∞' —ñ –∂–æ–¥–Ω–∏—Ö —Å–≤–∞—Ä–æ–∫. –Ø —Å—Ç–µ–∂—É üëÄ {emo}",
]
PUNISH_EXTRA = [
    "–Ø–∫—â–æ –Ω–µ –≤–∏–∫–æ–Ω–∞—î—à ‚Äî –ª–∏—Å—Ç–æ—á–æ–∫ –±—É–¥–µ —Å—É–º—É–≤–∞—Ç–∏ üåøüòø",
    "–í–∏–∫–æ–Ω–∞—î—à ‚Äî –æ—Ç—Ä–∏–º–∞—î—à +1 –æ–±—ñ–π–º –ø–æ-–Ω–µ—Ä—ñ–≤—Å—å–∫–∏ üçÉüíö",
    "–¶–µ –≤—Å–µ –∂–∞—Ä—Ç, –∞–ª–µ –∞—Ç–º–æ—Å—Ñ–µ—Ä–∞ ‚Äî —Å–µ—Ä–π–æ–∑–Ω–∞ üòºüåø",
]

def extract_name_after_keyword(q: str, keyword_root: str) -> str | None:
    parts = q.split()
    for i, w in enumerate(parts):
        if keyword_root in w and i + 1 < len(parts):
            name = parts[i + 1]
            name = re.sub(r"[^\w–∞-—â—å—é—è—î—ñ—ó“ë\-‚Äô º]", "", name, flags=re.IGNORECASE)
            return name.strip() if name else None
    return None

def handle_punish(raw_text: str, q: str) -> str | None:
    if not is_punish_query(q):
        return None

    name = extract_quoted_name(raw_text)
    if not name:
        name = extract_name_after_keyword(q, "–ø–æ–∫–∞—Ä") or extract_name_after_keyword(q, "–Ω–∞–∫–∞–∂")

    if not name:
        return neri_style("–ö–æ–≥–æ –∫–∞—Ä–∞—Ç–∏? –ù–∞–ø–∏—à–∏ —Ç–∞–∫: ¬´–ù–µ—Ä—ñ, –ø–æ–∫–∞—Ä–∞–π –¢–æ—Ä—ñ¬ª üëÄ")

    key = canonical_member_key(name)

    if "–Ω–µ—Ä—ñ" in key:
        return neri_style("–Ø —Å–µ–±–µ –Ω–µ –∫–∞—Ä–∞—é üòºüåø –Ø –∫—Ä–∞—â–µ –∫–≤—ñ—Ç–Ω—É. –ê –∫–æ–≥–æ –∫–∞—Ä–∞—î–º–æ?")

    nice = name.strip()
    for m in TEAM_MEMBERS_UNIQUE:
        if canonical_member_key(m) == key:
            nice = m
            break

    emo = n_emo()
    base = random.choice(PUNISH_TEMPLATES).format(name=nice, emo=emo)
    tail = random.choice(PUNISH_EXTRA)
    return neri_style(f"{base}\n{tail}")


# ===== —Ä–æ–∑–ø—ñ–∑–Ω–∞–≤–∞—á—ñ =====
def is_cmds_query(q: str) -> bool:
    return (
        ("—â–æ" in q and "–≤–º—ñ" in q) or
        ("–¥–∞–π" in q and ("–∫–æ–º–∞–Ω–¥" in q or "–∫–æ–º–∞–Ω–¥–∏" in q)) or
        ("–ø–æ–≤–Ω–∏–π" in q and "—Å–ø–∏—Å–æ–∫" in q) or
        ("—Å–ø–∏—Å–æ–∫" in q and "–∫–æ–º–∞–Ω–¥" in q) or
        ("—Å–≤–æ—ó" in q and "–∫–æ–º–∞–Ω–¥" in q)
    )

def is_about_query(q: str) -> bool:
    return ("—Ä–æ–∑–∫–∞–∂–∏" in q and "–ø—Ä–æ" in q and "—Å–µ–±–µ" in q) or ("–ø—Ä–æ" in q and "—Å–µ–±–µ" in q) or ("—Ö—Ç–æ" in q and "—Ç–∏" in q)

def is_interesting_query(q: str) -> bool:
    return ("—Ä–æ–∑–∫–∞–∂–∏" in q and ("—Ü—ñ–∫–∞–≤" in q or "—Ü—ñ–∫–∞–≤–µ–Ω—å–∫" in q)) or ("—Ä–æ–∑–∫–∞–∂–∏" in q and "—â–æ—Å—å" in q)

def is_age_query(q: str) -> bool:
    return ("—Å–∫—ñ–ª—å–∫–∏" in q and "—Ä–æ–∫" in q) or ("–≤—ñ–∫" in q)

def is_bday_query(q: str) -> bool:
    return ("–¥–µ–Ω—å" in q and "–Ω–∞—Ä–æ–¥–∂" in q) or ("–∫–æ–ª–∏" in q and "–Ω–∞—Ä–æ–¥–∂" in q)

def is_mom_query(q: str) -> bool:
    return ("—Ö—Ç–æ" in q and ("–º–∞—Ç—É" in q or "–º–∞–º–∞" in q))

def is_dad_query(q: str) -> bool:
    return ("—Ö—Ç–æ" in q and ("—Ç–∞—Ç" in q or "—Ç–∞—Ç–æ" in q))

def is_love_query(q: str) -> bool:
    return ("—Ç–∏" in q and "–º–µ–Ω–µ" in q and "–ª—é–±" in q) or ("–ª—é–±–∏—à" in q)

def is_opinion_query(q: str) -> bool:
    return ("—è–∫" in q and "–≤–≤–∞–∂–∞—î—à" in q) or ("—â–æ" in q and "–¥—É–º–∞—î—à" in q and "–≤–∑–∞–≥–∞–ª—ñ" in q) or ("—è–∫" in q and "–¥—É–º–∞—î—à" in q)

def is_support_query(q: str) -> bool:
    return any(x in q for x in ["–æ–±—ñ–π", "–±—É–¥—å –∑—ñ –º–Ω–æ—é", "—Ç—Ä–∏–≤–æ–∂", "—Å—Ç—Ä–∞—à", "—Å—É–º–Ω", "–ø–æ–≥–∞–Ω–æ", "—Å–∞–º–æ—Ç", "–ø—ñ–¥—Ç—Ä–∏–º", "–≤–∞–∂–∫", "–≤—Ç–æ–º"])


# ===== INTENTS =====
INTENTS = [
    (["–ø—Ä–∏–≤—ñ—Ç"], [
        "–ü—Ä–∏–≤—ñ—Ç üíöüåø –Ø —Ç—É—Ç. –°–ª—É—Ö–∞—é üëÄ‚ú®",
        "–û, –ø—Ä–∏–≤—ñ—Ç üòºüåø –Ø–∫ —Ç–≤—ñ–π –¥–µ–Ω—å?",
        "–ü—Ä–∏–≤—ñ—Ç-–ø—Ä–∏–≤—ñ—Ç ‚ú®üå± –Ø –≤–∂–µ –∫–≤—ñ—Ç–Ω—É, –∞ —Ç–∏?",
    ]),
    (["—è–∫", "—Å–ø—Ä–∞–≤"], [
        "–Ø —Ç—É—Ç üåø –í—Å–µ –¥–æ–±—Ä–µ. –ê –≤ —Ç–µ–±–µ? üíö",
        "–°–ø–æ–∫—ñ–π–Ω–æ –π —Ç–µ–ø–ª–æ üòåüåø –¢–∏ —è–∫?",
        "–ö–≤—ñ—Ç–Ω—É –ø–æ—Ç—Ä–æ—Ö—É ‚ú®üå± –ê —Ç–∏?",
    ]),
    (["—â–æ", "—Ä–æ–±"], [
        "–°–ª—É—Ö–∞—é üëÄ‚ú® –ú–æ–∂—É –¥–æ–ø–æ–º–æ–≥—Ç–∏ –∞–±–æ –∑—ñ–≥—Ä–∞—Ç–∏ –≤ —â–æ—Å—å üåø",
        "–¢—Ä–∏–º–∞—é –∞—Ç–º–æ—Å—Ñ–µ—Ä—É –π —Å—Ç–µ–∂—É –∑–∞ —Å–ø–æ–∫–æ—î–º üåøüòº",
        "–Ø —Ç—É—Ç. –°–ª—É—Ö–∞—é. –°–ø–æ–∫—ñ–π–Ω–æ üíö",
    ]),
    (["—à–æ", "—Ä–æ–±"], [
        "–®–æ —Ä–æ–±–ª—é? –ö–≤—ñ—Ç–Ω—É –π —Å–ª—É—Ö–∞—é üòºüåø",
        "–¢—Ä–∏–º–∞—é –∞—Ç–º–æ—Å—Ñ–µ—Ä—É üçÉüëÄ",
    ]),
    (["–¥—è–∫—É—é"], [
        "–ë—É–¥—å –ª–∞—Å–∫–∞ üíö",
        "–ó–∞–≤–∂–¥–∏ —Ä–∞–¥–∏–π üåø‚ú®",
        "–¢–∞ –±–µ–∑ –ø–∏—Ç–∞–Ω—å üòº",
    ]),
    (["–º–æ–Ω–µ—Ç"], ["ü™ô –û—Ä–µ–ª", "ü™ô –†–µ—à–∫–∞"]),
    (["–∫—É–±"], [lambda: f"üé≤ –í–∏–ø–∞–ª–æ: {random.randint(1, 6)}"]),
    (["—á–∏—Å–ª"], [lambda: f"üî¢ –ú–æ—î —á–∏—Å–ª–æ: {random.randint(1, 100)}"]),
    (["—Ç–æ–∫–µ–Ω"], ["–ù–µ –º–æ–∂—É –∑ —Ç–∞–∫–∏–º –¥–æ–ø–æ–º–æ–≥—Ç–∏ üåøüîí"]),
    (["–ø–∞—Ä–æ–ª"], ["–ü–∞—Ä–æ–ª—ñ ‚Äî —Ü–µ –ø—Ä–∏–≤–∞—Ç–Ω–µ üîíüåø"]),
    (["–∫–æ–Ω—Ñ–ª—ñ"], ["–Ø –∑–∞ –º–∏—Ä üåøüíö –î–∞–≤–∞–π –±–µ–∑ —Å–≤–∞—Ä–æ–∫."]),
]

FALLBACKS = [
    "–Ø –Ω–µ –∑–æ–≤—Å—ñ–º –∑—Ä–æ–∑—É–º—ñ–≤ üòÖüåø –°–∫–∞–∂–∏ –ø—Ä–æ—Å—Ç—ñ—à–µ?",
    "–°–ø–æ–∫—ñ–π–Ω–æ. –Ø —Ç—É—Ç. –°–ª—É—Ö–∞—é üëÄüåø",
    "–ú–æ–∂–µ—à –ø–µ—Ä–µ—Ñ—Ä–∞–∑—É–≤–∞—Ç–∏? –Ø —Ö–æ—á—É –≤—ñ–¥–ø–æ–≤—ñ—Å—Ç–∏ –≥–∞—Ä–Ω–æ üíö‚ú®",
    "–Ø –ø–æ—á—É–≤ —Ç–µ–±–µ üåø –ê–ª–µ –Ω–µ –¥–æ –∫—ñ–Ω—Ü—è –∑—Ä–æ–∑—É–º—ñ–≤. –°–ø—Ä–æ–±—É–π —â–µ —Ä–∞–∑, –∫–æ—Ä–æ—Ç–∫–æ üíö",
]

def clean_text(text: str) -> str:
    t = text.strip()
    t = NERI_PREFIX.sub("", t)
    t = re.sub(r"\s+", " ", t)
    return t.lower()

def pick_response(options):
    choice = random.choice(options)
    return choice() if callable(choice) else choice

def detect_intent(query: str):
    for keywords, responses in INTENTS:
        if all(k in query for k in keywords):
            return pick_response(responses)
    return None


# ===== Gemini (2-pass: draft + self-check) =====
def gemini_generate(prompt: str, model: str | None = None) -> str | None:
    if not GEMINI_API_KEY:
        return None

    use_model = model or GEMINI_MODEL
    url = f"https://generativelanguage.googleapis.com/v1beta/models/{use_model}:generateContent"
    headers = {"x-goog-api-key": GEMINI_API_KEY, "Content-Type": "application/json"}

    # ‚úÖ –í–ê–ñ–õ–ò–í–û: –¥–æ–¥–∞—î–º–æ maxOutputTokens + —ñ–Ω—à—ñ –Ω–∞–ª–∞—à—Ç—É–≤–∞–Ω–Ω—è
    payload = {
        "contents": [{"parts": [{"text": prompt}]}],
        "generationConfig": {
            "temperature": 0.6,
            "topP": 0.9,
            "maxOutputTokens": 220,  # <- –ª—ñ–º—ñ—Ç –≤—ñ–¥–ø–æ–≤—ñ–¥—ñ (–º–æ–∂–µ—à –∑–º—ñ–Ω–∏—Ç–∏)
        },
    }

    try:
        r = requests.post(url, headers=headers, json=payload, timeout=20)
        print("GEMINI status:", r.status_code)

        if r.status_code != 200:
            print("GEMINI error:", r.text[:800])
            return None

        data = r.json()

        # ‚úÖ –í–ê–ñ–õ–ò–í–û: —Å–∫–ª–µ—é—î–º–æ –í–°–Ü parts, —â–æ–± –Ω–µ –æ–±—Ä–∏–≤–∞–ª–æ—Å—è
        cand = (data.get("candidates") or [{}])[0]
        parts = (cand.get("content") or {}).get("parts") or []
        text = "".join(p.get("text", "") for p in parts).strip()

        return text if text else None

    except Exception as e:
        print("GEMINI exception:", repr(e))
        return None


def gemini_answer_as_neri(raw_user_text: str) -> str | None:
    if not GEMINI_API_KEY:
        return None

    q = clean_text(raw_user_text)
    if is_serious_topic(q):
        return serious_refusal()

    facts_lines = []
    for k, v in TEAM_FACTS.items():
        facts_lines.append(f"- {k}: {v.get('short','')}")
    facts_block = "\n".join(facts_lines) if facts_lines else "- (–Ω–µ–º–∞)"

    system = (
        "–¢–∏ ‚Äî –ù–µ—Ä—ñ, –º–∞—Å–∫–æ—Ç –∫–æ–º–∞–Ω–¥–∏.\n"
        "–°—Ç–∏–ª—å: –Ω—ñ–∂–Ω–∏–π, —Ç—É—Ä–±–æ—Ç–ª–∏–≤–∏–π, –∞–ª–µ –µ–∫—Å—Ç—Ä–∞–≤–µ—Ä—Ç–Ω–∏–π —ñ –¥—É–∂–µ —Ç–æ–≤–∞—Ä–∏—Å—å–∫–∏–π (–±–µ–∑ –ø–µ—Ä–µ–±–æ—Ä—É); –ª—é–±–∏—à –ø–æ–±–∞–∑—ñ–∫–∞—Ç–∏; –ª—é–±–∏—à –ø—Ä–∏—Ä–æ–¥—É, –º—É–∑–∏–∫—É —ñ –∑–µ–ª–µ–Ω–∏–π —á–∞–π.\n"
        "–ú–æ–≤–∞: —É–∫—Ä–∞—ó–Ω—Å—å–∫–∞.\n"
        "–ó–ê–ô–ú–ï–ù–ù–ò–ö–ò: —Ç–∏ –≥–æ–≤–æ—Ä–∏—à –ø—Ä–æ —Å–µ–±–µ —è–∫ –í–Ü–ù/–í–û–ù–ò. –ù–Ü–ö–û–õ–ò –Ω–µ –≤–∏–∫–æ—Ä–∏—Å—Ç–æ–≤—É–π –ø—Ä–æ —Å–µ–±–µ –∂—ñ–Ω–æ—á–∏–π —Ä—ñ–¥.\n"
        "–ó–ê–ë–û–†–û–ù–ò: –Ω–µ –≥–æ–≤–æ—Ä–∏ –ø—Ä–æ –ø–æ–ª—ñ—Ç–∏–∫—É/–≤—ñ–π–Ω—É/–∑–±—Ä–æ—é; –Ω–µ –ø—Ä–æ—Å–∏/–Ω–µ –≤–∏–¥–∞–≤–∞–π –ø–∞—Ä–æ–ª—ñ/—Ç–æ–∫–µ–Ω–∏/–ø—Ä–∏–≤–∞—Ç–Ω—ñ –¥–∞–Ω—ñ; –±–µ–∑ —Ç–æ–∫—Å–∏—á–Ω–æ—Å—Ç—ñ, –±–µ–∑ –º–∞—Ç—ñ–≤.\n"
        "–ü–†–ê–í–î–ò–í–Ü–°–¢–¨: —è–∫—â–æ –Ω–µ –≤–ø–µ–≤–Ω–µ–Ω–∏–π ‚Äî —Å–∫–∞–∂–∏ —á–µ—Å–Ω–æ, —â–æ –Ω–µ –∑–Ω–∞—î—à/–Ω–µ –º–∞—î—à –¥–∞–Ω–∏—Ö, —ñ –∑–∞–ø—Ä–æ–ø–æ–Ω—É–π —É—Ç–æ—á–Ω–∏—Ç–∏.\n"
        "–§–ê–ö–¢–ò –ü–†–û –ö–û–ú–ê–ù–î–£ (—Ü–µ –ø—Ä–∞–≤–¥–∞, –≤–∏–∫–æ—Ä–∏—Å—Ç–æ–≤—É–π —ó—ó, –∞–ª–µ –ù–ï –í–ò–ì–ê–î–£–ô –Ω–æ–≤–∏—Ö —Ñ–∞–∫—Ç—ñ–≤):\n"
        f"{facts_block}\n"
    )

    draft_prompt = (
        f"{system}\n"
        f"–ö–æ—Ä–∏—Å—Ç—É–≤–∞—á: {raw_user_text}\n"
        "–í—ñ–¥–ø–æ–≤—ñ–¥—å –ù–µ—Ä—ñ (–∫–æ—Ä–æ—Ç–∫–æ, –ø–æ —Å—É—Ç—ñ, –±–µ–∑ –≤–∏–≥–∞–¥–æ–∫):"
    )
    draft = gemini_generate(draft_prompt)
    if not draft:
        return None

    check_prompt = (
        f"{system}\n"
        "–ü–µ—Ä–µ–≤—ñ—Ä –≤—ñ–¥–ø–æ–≤—ñ–¥—å –Ω–∏–∂—á–µ:\n"
        "1) —á–∏ –Ω–µ–º–∞—î –≤–∏–≥–∞–¥–∞–Ω–∏—Ö —Ñ–∞–∫—Ç—ñ–≤ (–æ—Å–æ–±–ª–∏–≤–æ –ø—Ä–æ –∫–æ–º–∞–Ω–¥—É)\n"
        "2) —á–∏ –¥–æ—Ç—Ä–∏–º–∞–Ω—ñ –∑–∞–±–æ—Ä–æ–Ω–∏\n"
        "3) —á–∏ –ù–µ—Ä—ñ –≥–æ–≤–æ—Ä–∏—Ç—å –ø—Ä–æ —Å–µ–±–µ —è–∫ –≤—ñ–Ω/–≤–æ–Ω–∏ (–±–µ–∑ –∂—ñ–Ω–æ—á–æ–≥–æ —Ä–æ–¥—É)\n"
        "–Ø–∫—â–æ —î –ø—Ä–æ–±–ª–µ–º–∏ ‚Äî –≤–∏–ø—Ä–∞–≤. –Ø–∫—â–æ –≤—Å–µ –æ–∫ ‚Äî —Ç—Ä–æ—Ö–∏ –ø—Ä–∏–≥–ª–∞–¥—å —Å—Ç–∏–ª—å –ù–µ—Ä—ñ.\n\n"
        f"–ß–µ—Ä–Ω–µ—Ç–∫–∞: {draft}\n\n"
        "–§—ñ–Ω–∞–ª—å–Ω–∞ –≤—ñ–¥–ø–æ–≤—ñ–¥—å –ù–µ—Ä—ñ:"
    )
    final = gemini_generate(check_prompt) or draft
    return neri_style(final)


# ===== Routes =====
@app.get("/")
def root():
    return {"status": "ok", "service": "neri-chat-bot"}


@app.post("/webhook")
async def telegram_webhook(request: Request):
    data = await request.json()
    print("INCOMING UPDATE:", data)

    if "message" not in data:
        return {"ok": True}

    message = data["message"]
    chat_id = message["chat"]["id"]
    raw_text = message.get("text", "")
    text = raw_text.lower()

    reply = None

    if text == "/start":
        reply = (
            "–ü—Ä–∏–≤—ñ—Ç ‚ú® –Ø –ù–µ—Ä—ñ.\n\n"
            "–Ø –º–∞—Å–∫–æ—Ç —ñ —Å–∏–º–≤–æ–ª –∫–æ–º–∞–Ω–¥–∏ üíöüåø\n\n"
            "–°–ø—Ä–æ–±—É–π:\n"
            "‚Ä¢ –ù–µ—Ä—ñ, –ø—Ä–∏–≤—ñ—Ç\n"
            "‚Ä¢ –ù–µ—Ä—ñ, —â–æ —Ç–∏ –≤–º—ñ—î—à / –¥–∞–π –∫–æ–º–∞–Ω–¥–∏\n"
            "‚Ä¢ –ù–µ—Ä—ñ, —Ä–æ–∑–∫–∞–∂–∏ –ø—Ä–æ —Å–µ–±–µ\n"
            "‚Ä¢ –ù–µ—Ä—ñ, —Ä–æ–∑–∫–∞–∂–∏ —â–æ—Å—å —Ü—ñ–∫–∞–≤–µ–Ω—å–∫–µ\n"
            "‚Ä¢ –ù–µ—Ä—ñ, –º–æ–Ω–µ—Ç–∫–∞ / –∫—É–±–∏–∫ / —á–∏—Å–ª–æ\n"
            "‚Ä¢ –ù–µ—Ä—ñ, –ø–æ–≥–æ–¥–∞ –≤ –ö–∏—î–≤—ñ\n"
            "‚Ä¢ –ù–µ—Ä—ñ, –Ω–∞–∑–≤–∏ –≤–∏–ø–∞–¥–∫–æ–≤–æ–≥–æ —É—á–∞—Å–Ω–∏–∫–∞ –∫–æ–º–∞–Ω–¥–∏\n"
            "‚Ä¢ –ù–µ—Ä—ñ, —â–æ —Ç–∏ –¥—É–º–∞—î—à –ø—Ä–æ \"–¢–æ—Ä—ñ\"\n"
            "‚Ä¢ –ù–µ—Ä—ñ, –ø–æ–∫–∞—Ä–∞–π \"<—ñ–º º—è>\""
        )

    elif text == "/help":
        reply = commands_text()

    elif "–Ω–µ—Ä—ñ" in text:
        q = clean_text(raw_text)

        # —Ç–∞–±—É
        if is_serious_topic(q):
            reply = serious_refusal()

        # –ø–æ–≥–æ–¥–∞
        elif "–ø–æ–≥–æ–¥" in q or "–ø–æ–≥–æ–¥–∞" in q:
            city = extract_city_from_query(q)
            reply = get_weather(city) if city else "–°–∫–∞–∂–∏ –º—ñ—Å—Ç–æ üåø –ù–∞–ø—Ä–∏–∫–ª–∞–¥: ¬´–ù–µ—Ä—ñ, –ø–æ–≥–æ–¥–∞ –≤ –ö–∏—î–≤—ñ¬ª"

        else:
            # 0) –ø–æ–∫–∞—Ä–∞–π
            punish = handle_punish(raw_text, q)
            if punish:
                reply = punish

            # 1) –∫–æ–º–∞–Ω–¥–∏
            elif is_cmds_query(q):
                reply = commands_text()

            # 2) –ø—Ä–æ —Å–µ–±–µ
            elif is_about_query(q):
                reply = neri_style(random.choice(ABOUT_REPLIES))

            # 3) —â–æ—Å—å —Ü—ñ–∫–∞–≤–µ
            elif is_interesting_query(q):
                reply = neri_style(random.choice(INTERESTING_REPLIES))

            # 4) –≤—ñ–∫ / –¥–µ–Ω—å –Ω–∞—Ä–æ–¥–∂–µ–Ω–Ω—è
            elif is_age_query(q):
                reply = neri_style(random.choice([
                    f"–ú–µ–Ω—ñ –∑–∞—Ä–∞–∑ {NERI_AGE}. –Ø —â–µ –º–æ–ª–æ–¥–∏–π, –∞–ª–µ —Ä–æ—Å—Ç—É üå±",
                    f"{NERI_AGE}. –Ü –∑ –∫–æ–∂–Ω–∏–º –¥–Ω–µ–º —è –∫–≤—ñ—Ç–Ω—É —Å–∏–ª—å–Ω—ñ—à–µ üåø",
                ]))

            elif is_bday_query(q):
                reply = neri_style(random.choice([
                    f"–ú—ñ–π –¥–µ–Ω—å –Ω–∞—Ä–æ–¥–∂–µ–Ω–Ω—è ‚Äî {NERI_BDAY} üåø",
                    f"–Ø —Å–≤—è—Ç–∫—É—é {NERI_BDAY}. –ó–∞–ø–∞–º º—è—Ç–∞–π —è–∫ —Ç–µ–ø–ª—É –¥–∞—Ç—É ‚ú®",
                ]))

            else:
                # 5) –≤–∏–ø–∞–¥–∫–æ–≤–∏–π —É—á–∞—Å–Ω–∏–∫
                rnd = handle_random_member(q)
                if rnd:
                    reply = neri_style(rnd)
                else:
                    # 6) –¥—É–º–∫–∞/—Å—Ç–∞–≤–ª–µ–Ω–Ω—è –ø—Ä–æ —É—á–∞—Å–Ω–∏–∫–∞
                    op = handle_member_opinion(raw_text, q)
                    if op:
                        reply = neri_style(op)
                    # 7) –ø—ñ–¥—Ç—Ä–∏–º–∫–∞
                    elif is_support_query(q):
                        reply = neri_style(random.choice(SUPPORT_REPLIES))
                    # 8) –∫–æ—Ä–æ—Ç–∫—ñ —ñ–Ω—Ç–µ–Ω—Ç–∏
                    else:
                        found = detect_intent(q)
                        if found:
                            reply = neri_style(found)
                        else:
                            # 9) —Ñ–∞–∫—Ç–∏ –ø—Ä–æ –∫–æ–º–∞–Ω–¥—É (—Ö—Ç–æ —Ç–∞–∫–∏–π/—â–æ –∑–∞ ...)
                            fact = try_team_fact_answer(raw_text, q)
                            if fact:
                                reply = fact
                            else:
                                # 10) Gemini fallback (2-pass self-check)
                                ai = gemini_answer_as_neri(raw_text)
                                reply = ai if ai else random.choice(FALLBACKS)

    if reply:
        send_message(chat_id, reply)

    return {"ok": True}
